name: ðŸš€ Production Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: ðŸ“š Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ”¨ Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL }}

      - name: ðŸš€ Deploy to Vercel
        working-directory: ./frontend
        run: npx vercel --token=${{ secrets.VERCEL_TOKEN }} --prod --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  deploy-backend:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: ðŸš€ Trigger Render deployment
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
          echo "âœ… Render deployment triggered"

  health-check:
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    steps:
      - name: â³ Wait for services
        run: sleep 60

      - name: ðŸ¥ Check frontend
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_FRONTEND_URL }})
          echo "Frontend status: $status"
          if [ "$status" != "200" ]; then exit 1; fi
          echo "âœ… Frontend healthy"

      - name: ðŸ¥ Check backend
        run: |
          status=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_API_URL }}/health)
          echo "Backend status: $status"
          if [ "$status" != "200" ]; then exit 1; fi
          echo "âœ… Backend healthy"

      - name: ðŸŽ‰ Success
        run: |
          echo "### ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "Frontend: ${{ secrets.PRODUCTION_FRONTEND_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "Backend: ${{ secrets.PRODUCTION_API_URL }}" >> $GITHUB_STEP_SUMMARY
      - name: ðŸ“š Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f test-requirements.txt ]; then pip install -r test-requirements.txt; fi

      - name: ðŸ§ª Run backend tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pytest --verbose --cov=. --cov-report=term-missing
          else
            echo "No tests found, skipping..."
          fi

  # Manual Approval for Production
  approve-deployment:
    needs: [frontend-test, backend-test]
    runs-on: ubuntu-latest
    environment:
      name: production-approval
    steps:
      - name: âœ… Deployment approved
        run: echo "Production deployment approved by ${{ github.actor }}"

  # Deploy Frontend to Vercel
  deploy-frontend:
    needs: approve-deployment
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://${{ steps.deploy.outputs.url }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./frontend

      - name: ðŸ“ Save deployment URL
        run: |
          echo "FRONTEND_URL=${{ steps.deploy.outputs.url }}" >> $GITHUB_ENV
          echo "### ðŸŒ Frontend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "URL: https://${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  # Deploy Backend to Render
  deploy-backend:
    needs: approve-deployment
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Trigger Render deployment
        run: |
          response=$(curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": false}')
          echo "Deployment triggered: $response"
          echo "### ðŸ–¥ï¸ Backend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "Render deployment initiated" >> $GITHUB_STEP_SUMMARY

      - name: â³ Wait for deployment
        run: sleep 60

  # Health Checks & Smoke Tests
  smoke-tests:
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ¥ Run health checks
        run: |
          echo "### ðŸ¥ Health Check Results" >> $GITHUB_STEP_SUMMARY
          
          # Frontend health check
          frontend_status=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_FRONTEND_URL }})
          echo "Frontend Status: $frontend_status" >> $GITHUB_STEP_SUMMARY
          
          # Backend health check
          backend_status=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_API_URL }}/health)
          echo "Backend Status: $backend_status" >> $GITHUB_STEP_SUMMARY
          
          if [ "$frontend_status" != "200" ] || [ "$backend_status" != "200" ]; then
            echo "âŒ Health checks failed!"
            exit 1
          fi
          
          echo "âœ… All health checks passed!"

      - name: ðŸ§ª Run smoke tests
        run: |
          # Test critical endpoints
          curl -f ${{ secrets.PRODUCTION_API_URL }}/api/vehicles || exit 1
          curl -f ${{ secrets.PRODUCTION_API_URL }}/api/alerts || exit 1
          echo "âœ… Smoke tests passed!" >> $GITHUB_STEP_SUMMARY

  # Rollback on failure
  rollback:
    needs: smoke-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: â®ï¸ Rollback deployment
        run: |
          echo "### âš ï¸ Deployment Failed - Rolling Back" >> $GITHUB_STEP_SUMMARY
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache": true, "rollback": true}'

  # Create GitHub Release
  create-release:
    needs: smoke-tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Generate version tag
        id: version
        run: |
          VERSION="v$(date +'%Y.%m.%d')-${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ðŸ“ Generate changelog
        id: changelog
        run: |
          CHANGELOG=$(git log --pretty=format:"- %s (%an)" $(git describe --tags --abbrev=0 2>/dev/null || echo '')..HEAD)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸŽ‰ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ## ðŸš€ Production Deployment
            
            **Deployed by:** ${{ github.actor }}
            **Commit:** ${{ github.sha }}
            
            ### ðŸ“‹ Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### ðŸŒ URLs
            - Frontend: ${{ secrets.PRODUCTION_FRONTEND_URL }}
            - Backend: ${{ secrets.PRODUCTION_API_URL }}
          draft: false
          prerelease: false

  # Notifications
  notify:
    needs: [smoke-tests, create-release]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¢ Send Discord notification
        if: secrets.DISCORD_WEBHOOK_URL != ''
        run: |
          STATUS="${{ needs.smoke-tests.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}"
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"**Production Deployment $STATUS**\",
              \"embeds\": [{
                \"title\": \"AI Predictive Maintenance\",
                \"description\": \"Deployed by ${{ github.actor }}\",
                \"color\": ${{ needs.smoke-tests.result == 'success' && '3066993' || '15158332' }},
                \"fields\": [
                  {\"name\": \"Commit\", \"value\": \"${{ github.event.head_commit.message }}\"},
                  {\"name\": \"Frontend\", \"value\": \"${{ secrets.PRODUCTION_FRONTEND_URL }}\"},
                  {\"name\": \"Backend\", \"value\": \"${{ secrets.PRODUCTION_API_URL }}\"}
                ]
              }]
            }"

      - name: ðŸ“¢ Send Slack notification
        if: secrets.SLACK_WEBHOOK_URL != ''
        run: |
          STATUS="${{ needs.smoke-tests.result == 'success' && ':white_check_mark: Success' || ':x: Failed' }}"
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"*Production Deployment $STATUS*\",
              \"blocks\": [{
                \"type\": \"section\",
                \"text\": {
                  \"type\": \"mrkdwn\",
                  \"text\": \"*AI Predictive Maintenance*\nDeployed by ${{ github.actor }}\n\n*Commit:* ${{ github.event.head_commit.message }}\n*Frontend:* ${{ secrets.PRODUCTION_FRONTEND_URL }}\n*Backend:* ${{ secrets.PRODUCTION_API_URL }}\"
                }
              }]
            }"

  # Cost Estimation
  cost-estimation:
    needs: smoke-tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ’° Calculate hosting costs
        run: |
          echo "### ðŸ’° Estimated Monthly Costs" >> $GITHUB_STEP_SUMMARY
          echo "- Vercel Pro: \$20/month" >> $GITHUB_STEP_SUMMARY
          echo "- Render Starter: \$7/month" >> $GITHUB_STEP_SUMMARY
          echo "- Total: ~\$27/month" >> $GITHUB_STEP_SUMMARY

  # Cleanup old artifacts
  cleanup:
    needs: smoke-tests
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§¹ Clean up old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '7 days'
          skip-recent: 3
      - name: ðŸ§¹ Clean up old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '7 days'
          skip-recent: 3
